const a3_0x41692e=a3_0x3131;function a3_0x389e(){const _0x457013=['student','findOne','\x20logged\x20in','json','length','Super\x20Admin','User','430ZmKbNq','Username\x20and\x20password\x20required','Username\x20is\x20required','Logout\x20successful','user','ceil','Internal\x20server\x20error','send','dotenv','User\x20','statuscode','Too\x20many\x20incorrect\x20attempts.\x20Try\x20again\x20after\x20','24h','message','221368QsLMXT','Invalid\x20credentials','6404080gIPDNl','verifyOTP','axios','../utils/blackList','username','descriptor','headers','toString','sign','1081640EgtZqM','9sqTCQn','Too\x20many\x20attempts.\x20Try\x20again\x20after\x20','role','otpAttempts','logout','bcrypt','3552piQlbx','data','env','fullname','subscriptionEnd','../model/userModel','618XZVTAC','11HyFMpn','OTP\x20not\x20generated','\x20logged\x20in\x20via\x20face\x20recognition','otpAttemptedAt','user\x20not\x20subscribe','jsonwebtoken','<><>otp','sqrt','../utils/auditlogger','now','OTP\x20has\x20been\x20sent\x20successfully\x20to\x20your\x20registered\x20mobile\x20number','1707480NPleyx','login','../service/sms.service','../model/studentModel','otpLockedUntil','OTP\x20is\x20required','_id','1136872ThSoiV','otp','compare','status','find','password','log','config','JWT_SECRET','\x20logged\x20in\x20successfully','split','body','otpExpiresAt','Face\x20not\x20recognized','2240PpCTAv','OTP\x20has\x20expired.\x20Please\x20request\x20a\x20new\x20one.','Unauthorized:\x20No\x20user\x20or\x20token\x20found','LOGIN','subscription','Invalid\x20OTP','save','LOGOUT'];a3_0x389e=function(){return _0x457013;};return a3_0x389e();}(function(_0x3cf3e6,_0x3f0524){const _0x54a966=a3_0x3131,_0xc08bb9=_0x3cf3e6();while(!![]){try{const _0x2c9f3c=-parseInt(_0x54a966(0x1c5))/0x1+-parseInt(_0x54a966(0x1b7))/0x2*(-parseInt(_0x54a966(0x187))/0x3)+-parseInt(_0x54a966(0x181))/0x4*(parseInt(_0x54a966(0x1a8))/0x5)+parseInt(_0x54a966(0x193))/0x6+-parseInt(_0x54a966(0x17a))/0x7+-parseInt(_0x54a966(0x19a))/0x8*(-parseInt(_0x54a966(0x17b))/0x9)+parseInt(_0x54a966(0x1c7))/0xa*(parseInt(_0x54a966(0x188))/0xb);if(_0x2c9f3c===_0x3f0524)break;else _0xc08bb9['push'](_0xc08bb9['shift']());}catch(_0x2a9627){_0xc08bb9['push'](_0xc08bb9['shift']());}}}(a3_0x389e,0x5270b));function a3_0x3131(_0x56a767,_0x564017){_0x56a767=_0x56a767-0x174;const _0x389e90=a3_0x389e();let _0x313193=_0x389e90[_0x56a767];return _0x313193;}const jwt=require(a3_0x41692e(0x18d)),bcrypt=require(a3_0x41692e(0x180)),dotenv=require(a3_0x41692e(0x1bf))[a3_0x41692e(0x1a1)](),UserSchema=require(a3_0x41692e(0x186)),logAudit=require(a3_0x41692e(0x190)),tokenBlacklist=require(a3_0x41692e(0x174)),{sendSMS}=require(a3_0x41692e(0x195)),studentModel=require(a3_0x41692e(0x196)),{default:axios}=require(a3_0x41692e(0x1c9));exports[a3_0x41692e(0x194)]=async(_0x168743,_0x1ae414)=>{const _0x126e5f=a3_0x41692e;try{const {username:_0x44ef28,password:_0x312ea7,descriptor:_0x348f34}=_0x168743[_0x126e5f(0x1a5)];if(_0x44ef28===_0x126e5f(0x1b5)){const _0x313b0a=await axios['post'](process[_0x126e5f(0x183)]['GLOBAL_URL']+'/api/login',{'username':_0x44ef28,'password':_0x312ea7}),_0x12fa25=_0x313b0a[_0x126e5f(0x182)];if(!_0x12fa25[_0x126e5f(0x19d)])return _0x1ae414[_0x126e5f(0x19d)](_0x12fa25[_0x126e5f(0x1c1)])[_0x126e5f(0x1be)]({'status':![],'message':_0x12fa25[_0x126e5f(0x1c4)]});const {userData:_0x52e471}=_0x12fa25,_0x173dc1=jwt[_0x126e5f(0x179)]({'id':_0x52e471[_0x126e5f(0x199)],'username':_0x52e471[_0x126e5f(0x175)],'role':_0x52e471['role']},process[_0x126e5f(0x183)][_0x126e5f(0x1a2)],{'expiresIn':_0x126e5f(0x1c3)});return _0x1ae414[_0x126e5f(0x19d)](0xc8)[_0x126e5f(0x1be)]({'status':!![],'token':_0x173dc1,'user':{'id':_0x52e471[_0x126e5f(0x199)],'username':_0x52e471['username'],'fullName':_0x52e471[_0x126e5f(0x184)],'role':_0x52e471[_0x126e5f(0x17d)],'subscription':_0x52e471[_0x126e5f(0x1ac)]||!![]}});}if(_0x348f34){const _0x2a955e=await UserSchema[_0x126e5f(0x19e)]({},{'descriptor':0x1,'username':0x1,'role':0x1,'fullname':0x1});function _0x34c243(_0x4a83ba,_0x50a887){const _0x582ece=_0x126e5f;let _0x96d556=0x0;for(let _0x20060b=0x0;_0x20060b<_0x4a83ba[_0x582ece(0x1b4)];_0x20060b++){let _0x206287=_0x4a83ba[_0x20060b]-_0x50a887[_0x20060b];_0x96d556+=_0x206287*_0x206287;}return Math[_0x582ece(0x18f)](_0x96d556);}let _0x1a72a0=null,_0x46ba43=Infinity;for(const _0x532b14 of _0x2a955e){if(!_0x532b14[_0x126e5f(0x176)]||_0x532b14[_0x126e5f(0x176)]['length']!==_0x348f34['length'])continue;const _0x53fe13=_0x34c243(_0x532b14['descriptor'],_0x348f34);_0x53fe13<_0x46ba43&&(_0x46ba43=_0x53fe13,_0x1a72a0=_0x532b14);}const _0x50ec44=0.4;if(!_0x1a72a0||_0x46ba43>_0x50ec44)return _0x1ae414['status'](0x190)[_0x126e5f(0x1b3)]({'message':_0x126e5f(0x1a7)});const _0x1de31c=jwt[_0x126e5f(0x179)]({'id':_0x1a72a0['id'],'username':_0x1a72a0[_0x126e5f(0x175)],'role':_0x1a72a0[_0x126e5f(0x17d)]},process[_0x126e5f(0x183)][_0x126e5f(0x1a2)],{'expiresIn':_0x126e5f(0x1c3)});return await logAudit({'user':{'id':_0x1a72a0['id'],'username':_0x1a72a0[_0x126e5f(0x175)]},'username':_0x1a72a0[_0x126e5f(0x175)],'action':_0x126e5f(0x1ab),'targetModel':_0x126e5f(0x1b6),'targetId':_0x1a72a0[_0x126e5f(0x199)],'description':'User\x20'+_0x1a72a0[_0x126e5f(0x175)]+_0x126e5f(0x18a)}),_0x1ae414[_0x126e5f(0x1b3)]({'token':_0x1de31c,'user':{'id':_0x1a72a0['id'],'username':_0x1a72a0['username'],'fullName':_0x1a72a0['fullname'],'role':_0x1a72a0[_0x126e5f(0x17d)],'subscription':_0x1a72a0[_0x126e5f(0x1ac)]},'distance':_0x46ba43});}if(!_0x44ef28||!_0x312ea7)return _0x1ae414['status'](0x190)['json']({'message':_0x126e5f(0x1b8)});const _0x5e81d9=await UserSchema[_0x126e5f(0x1b1)]({'username':_0x44ef28});if(!_0x5e81d9)return _0x1ae414[_0x126e5f(0x19d)](0x190)['json']({'message':_0x126e5f(0x1c6)});const _0x3d49d2=await bcrypt[_0x126e5f(0x19c)](_0x312ea7,_0x5e81d9[_0x126e5f(0x19f)]);if(!_0x3d49d2)return _0x1ae414['status'](0x190)[_0x126e5f(0x1b3)]({'message':_0x126e5f(0x1c6)});if(_0x5e81d9[_0x126e5f(0x17d)]===_0x126e5f(0x1b0)){_0x5e81d9[_0x126e5f(0x1ac)]&&_0x5e81d9[_0x126e5f(0x185)]<=Date[_0x126e5f(0x191)]()&&(_0x5e81d9[_0x126e5f(0x1ac)]=![],await _0x5e81d9[_0x126e5f(0x1ae)]());if(!_0x5e81d9['subscription'])return _0x1ae414[_0x126e5f(0x1b3)]({'status':![],'user':{'id':_0x5e81d9['id'],'username':_0x5e81d9[_0x126e5f(0x175)],'fullName':_0x5e81d9[_0x126e5f(0x184)],'role':_0x5e81d9?.[_0x126e5f(0x17d)],'subscription':_0x5e81d9?.[_0x126e5f(0x1ac)]},'message':_0x126e5f(0x18c)});if(_0x5e81d9[_0x126e5f(0x197)]&&_0x5e81d9[_0x126e5f(0x197)]>Date[_0x126e5f(0x191)]()){const _0x373bc5=Math[_0x126e5f(0x1bc)]((_0x5e81d9[_0x126e5f(0x197)]-Date[_0x126e5f(0x191)]())/0xea60);return _0x1ae414[_0x126e5f(0x19d)](0x1ad)[_0x126e5f(0x1be)]({'status':![],'message':_0x126e5f(0x17c)+_0x373bc5+'\x20minutes'});}const _0x3f4151=await studentModel[_0x126e5f(0x1b1)]({'user_id':_0x5e81d9['_id']}),_0xa8d713=Math['floor'](0x3e8+Math['random']()*0x2328)[_0x126e5f(0x178)]();return _0x5e81d9[_0x126e5f(0x19b)]=_0xa8d713,_0x5e81d9[_0x126e5f(0x1a6)]=new Date(Date[_0x126e5f(0x191)]()+0x1e*0x3c*0x3e8),_0x5e81d9[_0x126e5f(0x17e)]=0x0,_0x5e81d9[_0x126e5f(0x18b)]=null,_0x5e81d9[_0x126e5f(0x197)]=null,console[_0x126e5f(0x1a0)](_0x126e5f(0x18e),_0xa8d713),await _0x5e81d9['save'](),await logAudit({'user':{'id':_0x5e81d9['id'],'username':_0x5e81d9[_0x126e5f(0x175)]},'username':_0x5e81d9[_0x126e5f(0x175)],'action':_0x126e5f(0x1ab),'targetModel':'User','targetId':_0x5e81d9['_id'],'description':_0x126e5f(0x1c0)+_0x5e81d9[_0x126e5f(0x175)]+_0x126e5f(0x1b2)}),_0x1ae414[_0x126e5f(0x19d)](0xc8)[_0x126e5f(0x1be)]({'status':!![],'otp':_0xa8d713,'user':{'id':_0x5e81d9['id'],'username':_0x5e81d9[_0x126e5f(0x175)],'fullName':_0x5e81d9['fullname'],'role':_0x5e81d9?.[_0x126e5f(0x17d)],'subscription':_0x5e81d9?.[_0x126e5f(0x1ac)]},'message':_0x126e5f(0x192)});}const _0x4e2075=jwt[_0x126e5f(0x179)]({'id':_0x5e81d9['id'],'username':_0x5e81d9['username'],'role':_0x5e81d9['role']},process[_0x126e5f(0x183)][_0x126e5f(0x1a2)],{'expiresIn':_0x126e5f(0x1c3)});return await logAudit({'user':{'id':_0x5e81d9['id'],'username':_0x5e81d9[_0x126e5f(0x175)]},'username':_0x5e81d9['username'],'action':'LOGIN','targetModel':_0x126e5f(0x1b6),'targetId':_0x5e81d9[_0x126e5f(0x199)],'description':_0x126e5f(0x1c0)+_0x5e81d9['username']+_0x126e5f(0x1b2)}),_0x1ae414['json']({'token':_0x4e2075,'user':{'id':_0x5e81d9['id'],'username':_0x5e81d9[_0x126e5f(0x175)],'fullName':_0x5e81d9[_0x126e5f(0x184)],'role':_0x5e81d9?.[_0x126e5f(0x17d)],'subscription':_0x5e81d9?.['subscription']}});}catch(_0x2051e1){return console['log']('<><>error',_0x2051e1),_0x1ae414[_0x126e5f(0x19d)](0x1f4)[_0x126e5f(0x1b3)]({'message':_0x126e5f(0x1bd),'error':_0x2051e1[_0x126e5f(0x1c4)]});}},exports[a3_0x41692e(0x1c8)]=async(_0x4278ac,_0x2be9e5)=>{const _0x41577b=a3_0x41692e,{username:_0x531c03,otp:_0x243b06}=_0x4278ac['body'];try{if(!_0x531c03)return _0x2be9e5[_0x41577b(0x19d)](0x190)[_0x41577b(0x1be)]({'status':![],'message':_0x41577b(0x1b9)});if(!_0x243b06)return _0x2be9e5['status'](0x190)['send']({'status':![],'message':_0x41577b(0x198)});const _0x5a775a=await UserSchema[_0x41577b(0x1b1)]({'username':_0x531c03});if(!_0x5a775a)return _0x2be9e5[_0x41577b(0x19d)](0x190)['send']({'status':![],'message':'Invalid\x20username.\x20Please\x20contact\x20admin.'});if(_0x5a775a[_0x41577b(0x197)]&&_0x5a775a[_0x41577b(0x197)]>Date[_0x41577b(0x191)]()){const _0x308a18=Math['ceil']((_0x5a775a['otpLockedUntil']-Date['now']())/0xea60);return _0x2be9e5[_0x41577b(0x19d)](0x1ad)['send']({'status':![],'message':_0x41577b(0x1c2)+_0x308a18+'\x20minutes'});}if(!_0x5a775a[_0x41577b(0x19b)]||!_0x5a775a[_0x41577b(0x1a6)])return _0x2be9e5[_0x41577b(0x19d)](0x190)[_0x41577b(0x1b3)]({'status':![],'message':_0x41577b(0x189)});if(_0x5a775a[_0x41577b(0x1a6)]<Date[_0x41577b(0x191)]())return _0x2be9e5[_0x41577b(0x19d)](0x190)[_0x41577b(0x1b3)]({'status':![],'message':_0x41577b(0x1a9)});if(_0x243b06!==_0x5a775a[_0x41577b(0x19b)])return _0x5a775a[_0x41577b(0x17e)]=(_0x5a775a[_0x41577b(0x17e)]||0x0)+0x1,_0x5a775a[_0x41577b(0x18b)]=new Date(),_0x5a775a[_0x41577b(0x17e)]>=0x5&&(_0x5a775a[_0x41577b(0x197)]=new Date(Date[_0x41577b(0x191)]()+0xf*0x3c*0x3e8)),await _0x5a775a[_0x41577b(0x1ae)](),_0x2be9e5['status'](0x190)['json']({'status':![],'message':_0x41577b(0x1ad)});_0x5a775a['otp']=null,_0x5a775a['otpExpiresAt']=null,_0x5a775a['otpAttempts']=0x0,_0x5a775a[_0x41577b(0x197)]=null,await _0x5a775a[_0x41577b(0x1ae)]();const _0x5bf623=jwt[_0x41577b(0x179)]({'id':_0x5a775a[_0x41577b(0x199)],'username':_0x5a775a[_0x41577b(0x175)],'role':_0x5a775a[_0x41577b(0x17d)]},process[_0x41577b(0x183)][_0x41577b(0x1a2)],{'expiresIn':_0x41577b(0x1c3)});return await logAudit({'user':{'id':_0x5a775a['id'],'username':_0x5a775a[_0x41577b(0x175)]},'username':_0x5a775a[_0x41577b(0x175)],'action':_0x41577b(0x1ab),'targetModel':'User','targetId':_0x5a775a['_id'],'description':_0x41577b(0x1c0)+_0x5a775a['username']+_0x41577b(0x1a3)}),_0x2be9e5[_0x41577b(0x19d)](0xc8)[_0x41577b(0x1b3)]({'status':!![],'message':'OTP\x20verified\x20successfully','token':_0x5bf623,'user':{'id':_0x5a775a['id'],'username':_0x5a775a[_0x41577b(0x175)],'fullName':_0x5a775a['fullname'],'role':_0x5a775a[_0x41577b(0x17d)],'subscription':_0x5a775a[_0x41577b(0x1ac)]}});}catch(_0x3b7dd1){return _0x2be9e5['status'](0x1f4)[_0x41577b(0x1b3)]({'status':![],'message':'Server\x20error','error':_0x3b7dd1[_0x41577b(0x1c4)]});}},exports[a3_0x41692e(0x17f)]=async(_0x1b6b74,_0x218ab3)=>{const _0x53086b=a3_0x41692e;try{const _0x4fe8bd=_0x1b6b74[_0x53086b(0x1bb)],_0x294217=_0x1b6b74[_0x53086b(0x177)]['authorization']?.[_0x53086b(0x1a4)]('\x20')[0x1];if(!_0x4fe8bd||!_0x294217)return _0x218ab3[_0x53086b(0x19d)](0x191)['json']({'message':_0x53086b(0x1aa)});tokenBlacklist['add'](_0x294217),await logAudit({'user':{'id':_0x4fe8bd['id'],'username':_0x4fe8bd['username']},'username':_0x4fe8bd[_0x53086b(0x175)],'action':_0x53086b(0x1af),'targetModel':_0x53086b(0x1b6),'targetId':_0x4fe8bd['id'],'description':_0x53086b(0x1c0)+_0x4fe8bd[_0x53086b(0x175)]+'\x20logged\x20out'}),_0x218ab3[_0x53086b(0x19d)](0xc8)[_0x53086b(0x1b3)]({'message':_0x53086b(0x1ba)});}catch(_0x5e8a88){_0x218ab3[_0x53086b(0x19d)](0x1f4)[_0x53086b(0x1b3)]({'message':_0x53086b(0x1bd),'error':_0x5e8a88[_0x53086b(0x1c4)]});}};