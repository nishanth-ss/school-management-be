const a20_0x5b5219=a20_0x2e42;(function(_0x341735,_0x226363){const _0x4f53a0=a20_0x2e42,_0x1cf55b=_0x341735();while(!![]){try{const _0x52ca35=parseInt(_0x4f53a0(0x16d))/0x1+parseInt(_0x4f53a0(0x18b))/0x2*(parseInt(_0x4f53a0(0x167))/0x3)+parseInt(_0x4f53a0(0x14b))/0x4*(parseInt(_0x4f53a0(0x17d))/0x5)+-parseInt(_0x4f53a0(0x159))/0x6*(parseInt(_0x4f53a0(0x169))/0x7)+-parseInt(_0x4f53a0(0x1a1))/0x8*(-parseInt(_0x4f53a0(0x18a))/0x9)+-parseInt(_0x4f53a0(0x192))/0xa*(parseInt(_0x4f53a0(0x181))/0xb)+parseInt(_0x4f53a0(0x176))/0xc*(parseInt(_0x4f53a0(0x187))/0xd);if(_0x52ca35===_0x226363)break;else _0x1cf55b['push'](_0x1cf55b['shift']());}catch(_0x554df7){_0x1cf55b['push'](_0x1cf55b['shift']());}}}(a20_0xf677,0x9c0f9));const UserSchema=require(a20_0x5b5219(0x177)),bcrypt=require(a20_0x5b5219(0x16b)),mongoose=require('mongoose'),logAudit=require(a20_0x5b5219(0x185)),userModel=require(a20_0x5b5219(0x177)),faceapi=require('face-api.js'),inmateModel=require('../model/studentModel'),{faceRecognitionService,faceRecognitionExcludeUserService}=require(a20_0x5b5219(0x1a0)),{findByIdAndUpdate}=require(a20_0x5b5219(0x14c)),defaultUser=async(_0x5b90b3,_0x2bfd0a)=>{const _0x298073=a20_0x5b5219;try{const _0x28f328=await UserSchema[_0x298073(0x195)]({});if(_0x28f328['length']===0x0){const _0x3a7a12=await bcrypt[_0x298073(0x16a)](_0x298073(0x19d),0xa),_0x4489ff=new UserSchema({'username':'Admin','fullname':'Super\x20Admin','password':_0x3a7a12,'role':_0x298073(0x156)});await _0x4489ff[_0x298073(0x155)](),_0x2bfd0a[_0x298073(0x171)](0xc8)[_0x298073(0x16f)]({'success':!![],'message':_0x298073(0x14f)});}else return _0x2bfd0a[_0x298073(0x171)](0xc8)[_0x298073(0x16f)]({'success':!![],'message':_0x298073(0x165)});}catch(_0x37f500){console['error'](_0x298073(0x19a),_0x37f500[_0x298073(0x18c)]);}},createUser=async(_0x502491,_0x6a0629)=>{const _0x560d31=a20_0x5b5219;try{const {username:_0x5a63ac,fullname:_0x5386b9,role:_0x1269a1,password:_0x51b975,locationId:_0x4f99ac,descriptor:_0x57f010}=_0x502491['body'];if(!_0x4f99ac)return _0x6a0629['status'](0x190)[_0x560d31(0x179)]({'message':_0x560d31(0x15c)});if(_0x57f010){const _0x2254ef=await faceRecognitionService(_0x57f010);if(_0x2254ef[_0x560d31(0x171)])return _0x6a0629[_0x560d31(0x171)](0x190)[_0x560d31(0x16f)]({'success':![],'message':_0x560d31(0x17b)+_0x2254ef[_0x560d31(0x197)]});}if(!_0x5a63ac||!_0x5386b9||!_0x1269a1||!_0x51b975)return _0x6a0629[_0x560d31(0x171)](0x190)['json']({'message':_0x560d31(0x190)});const _0x1efd6d=await UserSchema['findOne']({'username':_0x5a63ac});if(_0x1efd6d)return _0x6a0629[_0x560d31(0x171)](0x199)['json']({'message':_0x560d31(0x166)});const _0x17a0b5=await bcrypt[_0x560d31(0x16a)](_0x51b975,0xa),_0x44b02a=new UserSchema({'username':_0x5a63ac,'fullname':_0x5386b9,'password':_0x17a0b5,'role':_0x1269a1,'location_id':_0x4f99ac,'descriptor':_0x57f010}),_0x500773=await _0x44b02a[_0x560d31(0x155)]();await logAudit({'userId':_0x502491[_0x560d31(0x15f)]['id'],'username':_0x502491[_0x560d31(0x15f)]['username'],'action':_0x560d31(0x170),'targetModel':_0x560d31(0x14d),'targetId':_0x500773[_0x560d31(0x17c)],'description':'Created\x20new\x20user\x20\x22'+_0x500773[_0x560d31(0x197)]+_0x560d31(0x1a2)+_0x500773[_0x560d31(0x15a)]+'\x22','changes':{'username':_0x500773[_0x560d31(0x197)],'fullname':_0x500773[_0x560d31(0x17e)],'role':_0x500773[_0x560d31(0x15a)]}}),_0x6a0629[_0x560d31(0x171)](0xc9)[_0x560d31(0x179)]({'success':!![],'data':_0x500773,'message':_0x560d31(0x18d)});}catch(_0x53373b){_0x6a0629['status'](0x1f4)[_0x560d31(0x179)]({'success':![],'message':'Internal\x20server\x20error','error':_0x53373b[_0x560d31(0x18c)]});}},faceRecongition=async(_0x26f3c5,_0x41cec5)=>{const _0x44fbf8=a20_0x5b5219;try{const {descriptor:_0x912cbe,userId:_0x3db146}=_0x26f3c5[_0x44fbf8(0x14a)],_0x5f2485=await faceRecognitionService(_0x912cbe);await userModel['findByIdAndUpdate'](_0x3db146,{'descriptor':_0x912cbe})[_0x44fbf8(0x164)](_0x4aac11=>{const _0x34a23d=_0x44fbf8;return _0x41cec5[_0x34a23d(0x171)](0xc8)['send']({'success':!![],'data':_0x26f3c5[_0x34a23d(0x14a)][_0x34a23d(0x172)],'message':_0x34a23d(0x19b)});})['catch'](_0x409307=>{const _0x27f73c=_0x44fbf8;_0x41cec5[_0x27f73c(0x171)](0x1f4)[_0x27f73c(0x16f)]({'success':![],'message':_0x27f73c(0x173),'err':_0x409307});});}catch(_0xa69aaf){_0x41cec5['status'](0x1f4)[_0x44fbf8(0x179)]({'success':![],'message':'Internal\x20server\x20error','error':_0xa69aaf[_0x44fbf8(0x18c)]});}},faceRecongitionMatch=async(_0x4e166f,_0x2bef35)=>{const _0x5671ce=a20_0x5b5219;try{const {userId:_0x19856c,descriptor:_0x256c4b}=_0x4e166f[_0x5671ce(0x14a)],_0x496cee=await faceRecognitionService(_0x256c4b);if(_0x496cee[_0x5671ce(0x171)])return _0x2bef35[_0x5671ce(0x171)](0x193)[_0x5671ce(0x16f)]({'sucess':![],'message':_0x5671ce(0x15e)});if(!_0x19856c)return _0x2bef35['status'](0x194)['send']({'success':![],'message':_0x5671ce(0x199)});if(!_0x256c4b)return _0x2bef35[_0x5671ce(0x171)](0x194)[_0x5671ce(0x16f)]({'success':![],'message':_0x5671ce(0x175)});const _0x4ea5c8=await userModel['findById'](_0x19856c),_0x345982=faceapi[_0x5671ce(0x161)](_0x4ea5c8[_0x5671ce(0x172)],_0x256c4b),_0x200b77=0.4,_0xb384c3=_0x345982<_0x200b77;return _0xb384c3?_0x2bef35[_0x5671ce(0x171)](0xc8)[_0x5671ce(0x16f)]({'success':!![],'message':'face\x20recognition\x20success','faceMatch':_0xb384c3}):_0x2bef35['status'](0xc8)[_0x5671ce(0x16f)]({'success':![],'message':'face\x20recognition\x20not\x20match','faceMatch':_0xb384c3});}catch(_0x4ecf05){_0x2bef35[_0x5671ce(0x171)](0x1f4)[_0x5671ce(0x16f)]({'success':![],'message':'internal\x20server\x20down','error':_0x4ecf05});}},getAllUsers=async(_0x54614a,_0x7ecfe6)=>{const _0x14a8de=a20_0x5b5219,_0x5da99c=parseInt(_0x54614a[_0x14a8de(0x152)][_0x14a8de(0x19c)])||0x1,_0xd949e4=parseInt(_0x54614a[_0x14a8de(0x152)][_0x14a8de(0x17a)])||0xa,_0x5e5ac7=(_0x5da99c-0x1)*_0xd949e4,_0x2be482=_0x54614a[_0x14a8de(0x152)][_0x14a8de(0x149)]||_0x14a8de(0x193),_0x5b7863=_0x54614a['query'][_0x14a8de(0x150)]===_0x14a8de(0x19f)?0x1:-0x1;try{const _0x228999=await UserSchema[_0x14a8de(0x153)](),_0xc51922=await UserSchema[_0x14a8de(0x195)]()['select'](_0x14a8de(0x18e))['populate'](_0x14a8de(0x15a),'roleName')[_0x14a8de(0x174)]({[_0x2be482]:_0x5b7863})[_0x14a8de(0x19e)](_0x5e5ac7)[_0x14a8de(0x17a)](_0xd949e4);if(!_0xc51922[_0x14a8de(0x151)])return _0x7ecfe6[_0x14a8de(0x171)](0x194)['json']({'success':![],'message':_0x14a8de(0x14e),'data':[]});const _0x3d3cb4=_0x7ecfe6[_0x14a8de(0x179)]({'success':!![],'data':_0xc51922,'currentPage':_0x5da99c,'totalPages':Math[_0x14a8de(0x158)](_0x228999/_0xd949e4),'totalItems':_0x228999,'message':'Users\x20fetched\x20successfully'});}catch(_0x2de765){_0x7ecfe6['status'](0x1f4)['json']({'success':![],'message':'Internal\x20server\x20error','error':_0x2de765['message']});}},getUserById=async(_0xaef29b,_0x409d11)=>{const _0x272624=a20_0x5b5219;try{const {id:_0x24f5a9}=_0xaef29b[_0x272624(0x17f)];if(!_0x24f5a9)return _0x409d11[_0x272624(0x171)](0x190)[_0x272624(0x179)]({'message':_0x272624(0x196)});if(!mongoose[_0x272624(0x162)][_0x272624(0x16c)][_0x272624(0x178)](_0x24f5a9))return _0x409d11['status'](0x190)['json']({'message':_0x272624(0x16e)});const _0x52af32=await UserSchema['findById'](_0x24f5a9)[_0x272624(0x194)]('-password');if(!_0x52af32)return _0x409d11['status'](0x194)[_0x272624(0x179)]({'success':![],'message':'User\x20not\x20found'});_0x409d11[_0x272624(0x179)]({'success':!![],'data':_0x52af32});}catch(_0x387d6c){_0x409d11['status'](0x1f4)[_0x272624(0x179)]({'success':![],'message':_0x272624(0x168),'error':_0x387d6c[_0x272624(0x18c)]});}},updateUserById=async(_0x5342c3,_0x102522)=>{const _0x2cffce=a20_0x5b5219;try{const {username:_0x4e0297,fullname:_0x39a7f0,role:_0x38c8f5,newPassword:_0x2585ee,oldPassword:_0x279e36,descriptor:_0xf5c78d}=_0x5342c3[_0x2cffce(0x14a)],_0x4b4abd={},_0x25ecf1=await faceRecognitionExcludeUserService(_0xf5c78d,_0x5342c3[_0x2cffce(0x17f)]['id']);if(_0x25ecf1[_0x2cffce(0x171)])return _0x102522[_0x2cffce(0x171)](0x190)[_0x2cffce(0x16f)]({'status':![],'message':_0x2cffce(0x17b)+_0x25ecf1[_0x2cffce(0x197)]});const _0x1049c3=await UserSchema[_0x2cffce(0x18f)](_0x5342c3[_0x2cffce(0x17f)]['id']);if(!_0x1049c3)return _0x102522[_0x2cffce(0x171)](0x194)[_0x2cffce(0x179)]({'success':![],'message':_0x2cffce(0x182)});if(_0x4e0297){const _0x4f1e63=await UserSchema[_0x2cffce(0x183)]({'username':_0x4e0297});if(_0x4f1e63&&_0x4f1e63[_0x2cffce(0x17c)]['toString']()!==_0x5342c3[_0x2cffce(0x17f)]['id'])return _0x102522[_0x2cffce(0x171)](0x199)[_0x2cffce(0x179)]({'success':![],'message':_0x2cffce(0x166)});_0x4b4abd[_0x2cffce(0x197)]=_0x4e0297;}if(_0x2585ee){if(!_0x279e36)return _0x102522[_0x2cffce(0x171)](0x190)[_0x2cffce(0x179)]({'success':![],'message':'Old\x20password\x20is\x20required\x20to\x20set\x20a\x20new\x20password'});const _0x2bb5bf=await bcrypt[_0x2cffce(0x163)](_0x279e36,_0x1049c3[_0x2cffce(0x157)]);if(!_0x2bb5bf)return _0x102522[_0x2cffce(0x171)](0x190)['json']({'success':![],'message':_0x2cffce(0x189)});_0x4b4abd[_0x2cffce(0x157)]=await bcrypt['hash'](_0x2585ee,0xa);}if(_0x39a7f0)_0x4b4abd[_0x2cffce(0x17e)]=_0x39a7f0;if(_0x38c8f5)_0x4b4abd[_0x2cffce(0x15a)]=_0x38c8f5;if(_0xf5c78d)_0x4b4abd[_0x2cffce(0x172)]=_0xf5c78d;const _0x1e0094=await UserSchema[_0x2cffce(0x15d)](_0x5342c3[_0x2cffce(0x17f)]['id'],{'$set':_0x4b4abd},{'new':!![],'runValidators':!![]})[_0x2cffce(0x194)](_0x2cffce(0x18e));await logAudit({'userId':_0x5342c3[_0x2cffce(0x15f)]['id'],'username':_0x5342c3[_0x2cffce(0x15f)][_0x2cffce(0x197)],'action':'UPDATE','targetModel':_0x2cffce(0x14d),'targetId':_0x1e0094['_id'],'description':_0x2cffce(0x160)+_0x1e0094[_0x2cffce(0x197)]+'\x22','changes':_0x4b4abd}),_0x102522[_0x2cffce(0x179)]({'success':!![],'data':_0x1e0094,'message':_0x2cffce(0x188)});}catch(_0x2d5279){_0x102522[_0x2cffce(0x171)](0x1f4)[_0x2cffce(0x179)]({'success':![],'message':_0x2cffce(0x168),'error':_0x2d5279[_0x2cffce(0x18c)]});}},deleteUser=async(_0x12b0f1,_0x5142fd)=>{const _0xa1be60=a20_0x5b5219;try{const _0x3251a0=await UserSchema[_0xa1be60(0x15b)](_0x12b0f1[_0xa1be60(0x17f)]['id']);if(!_0x3251a0)return _0x5142fd[_0xa1be60(0x171)](0x194)[_0xa1be60(0x179)]({'success':![],'message':_0xa1be60(0x182)});await inmateModel[_0xa1be60(0x180)]({'inmateId':_0x3251a0[_0xa1be60(0x154)]}),await logAudit({'userId':_0x12b0f1[_0xa1be60(0x15f)]['id'],'username':_0x12b0f1[_0xa1be60(0x15f)][_0xa1be60(0x197)],'action':'DELETE','targetModel':_0xa1be60(0x14d),'targetId':_0x3251a0['_id'],'description':_0xa1be60(0x186)+_0x3251a0[_0xa1be60(0x197)]+_0xa1be60(0x1a2)+_0x3251a0['role']+'\x22','changes':{'username':_0x3251a0[_0xa1be60(0x197)],'fullname':_0x3251a0[_0xa1be60(0x17e)],'role':_0x3251a0[_0xa1be60(0x15a)]}}),_0x5142fd['json']({'success':!![],'message':'User\x20deleted\x20successfully'});}catch(_0x17f2f1){_0x5142fd[_0xa1be60(0x171)](0x1f4)[_0xa1be60(0x179)]({'success':![],'message':_0xa1be60(0x168),'error':_0x17f2f1[_0xa1be60(0x18c)]});}},deleteFaceRecognitionRecord=async(_0x47e0bc,_0x5d603c)=>{const _0x240ea6=a20_0x5b5219;try{const {id:_0x56645c}=_0x47e0bc[_0x240ea6(0x17f)];if(!_0x56645c)return _0x5d603c[_0x240ea6(0x171)](0x194)[_0x240ea6(0x16f)]({'sucess':![],'message':_0x240ea6(0x184)});await UserSchema[_0x240ea6(0x15d)](_0x56645c,{'descriptor':[]})[_0x240ea6(0x164)](_0x2a178b=>{const _0x5ad1fb=_0x240ea6;return _0x5d603c[_0x5ad1fb(0x171)](0xc8)[_0x5ad1fb(0x16f)]({'status':!![],'message':'face\x20recogintion\x20data\x20deleted\x20successfully'});})[_0x240ea6(0x191)](_0x2d1ab3=>{const _0x3e8d35=_0x240ea6;return _0x5d603c[_0x3e8d35(0x171)](0x1f4)[_0x3e8d35(0x16f)]({'status':!![],'message':'internal\x20server\x20down','error':_0x2d1ab3[_0x3e8d35(0x18c)]});});}catch(_0x1b8479){_0x5d603c[_0x240ea6(0x171)](0x1f4)[_0x240ea6(0x179)]({'success':![],'message':_0x240ea6(0x168),'error':_0x1b8479['message']});}};module[a20_0x5b5219(0x198)]={'createUser':createUser,'getAllUsers':getAllUsers,'getUserById':getUserById,'updateUserById':updateUserById,'deleteUser':deleteUser,'defaultUser':defaultUser,'faceRecongition':faceRecongition,'faceRecongitionMatch':faceRecongitionMatch,'deleteFaceRecognitionRecord':deleteFaceRecognitionRecord};function a20_0x2e42(_0x44c79b,_0x29ed13){_0x44c79b=_0x44c79b-0x149;const _0xf677ed=a20_0xf677();let _0x2e421a=_0xf677ed[_0x44c79b];return _0x2e421a;}function a20_0xf677(){const _0x183ba7=['Error\x20creating\x20default\x20user:','success\x20continue','page','admin@123','skip','asc','../service/faceRecognitionService','8LdQcoL','\x22\x20with\x20role\x20\x22','sortField','body','332QidHAh','../model/departmentModel','User','No\x20data\x20found','admin\x20created\x20successfully','sortOrder','length','query','countDocuments','inmateId','save','ADMIN','password','ceil','158778JAbJFZ','role','findByIdAndDelete','location\x20is\x20required','findByIdAndUpdate','Face\x20recognition\x20record\x20already\x20exists','user','Updated\x20user\x20\x22','euclideanDistance','Types','compare','then','user\x20already\x20created','Username\x20already\x20exists','3crmCkg','Internal\x20server\x20error','322AyyOdY','hash','bcrypt','ObjectId','48048rXklaz','Invalid\x20ID\x20format','send','CREATE','status','descriptor','internal\x20server\x20down','sort','descriptor\x20could\x20not\x20find','92172kxvUOL','../model/userModel','isValid','json','limit','A\x20face\x20record\x20already\x20exists\x20for\x20user\x20','_id','24715gOycMZ','fullname','params','deleteOne','14179OSHMJX','User\x20not\x20found','findOne','could\x20not\x20find\x20any\x20id','../utils/auditlogger','Deleted\x20user\x20\x22','130KIGVjf','User\x20updated\x20successfully','Old\x20password\x20is\x20incorrect','6488964syyBmM','1486958BwakiA','message','User\x20created\x20successfully','-password','findById','All\x20fields\x20are\x20required','catch','1110ZwoZWD','createdAt','select','find','user\x20ID\x20is\x20missing','username','exports','user\x20id\x20could\x20not\x20find'];a20_0xf677=function(){return _0x183ba7;};return a20_0xf677();}